require 'net/ssh'

#!/usr/bin/env ruby
# Usage: FS_local_recon <computer> -s <subject> <autorecon_options>

def run!(hostname, subject, options = {:server_analysis_dir => {}, :autorecon_options => ''})
	local_dir ||= '/Data/FS_local_recon'
	server_analysis_dir = options[:server_analysis_dir]
	dataset_path = File.join(server_analysis_dir, subject)

  run_commands_on hostname do
    commands = []
    commands << "export FREESURFER_HOME=/Applications/freesurfer"
    commands << "source $FREESURFER_HOME/SetUpFreeSurfer.sh"
    commands << "cp -r #{dataset_path} #{local_dir}"
  	commands << "export SUBJECTS_DIR='/Data/FS_local_recon/'"
    commands << "echo 'SUBJECTS_DIR': $SUBJECTS_DIR"
  	commands << "recon-all -s #{subject} #{options[:autorecon_options]}"
    commands << "mv #{File.join(local_dir, subject)} #{server_analysis_dir}"
    commands.join(";\n")
  end

end

def run_commands_on(hostname, &block)
  Net::SSH.start(hostname, "erik") do |ssh|
    puts ssh.exec!(yield)
    # puts yield
  end
end

if __FILE__ == $0
  run!
end